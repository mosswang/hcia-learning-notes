# 网络参考模型



## 网络协议

数据通信协议的定义:  决定数据的格式和传输的一组规则或者一组惯例。



![](..\images\20240218181632.png)

不同的协议栈用于定义和管理不同网络的数据转发规则。



网络通信的过程很复杂：

数据以电子信号的形式穿越介质到达正确的计算机，然后转换成最初的形式，以便接收者能够阅读。

为了降低网络设计的复杂性，将协议进行了分层设计。



分层设计的意义：

1. 通信服务层的模块设计可相对独立于具体的通信线路和通信硬件接口的差别。
2. 而通信服务层的模块设计又可相对独立于具体用户应用要求的不同。
3. 简化了相关的网络操作；提供了不同厂商之间的兼容性；促进了标准化工作；结构上进行了分层；易于学习和操作。
4. 各个层次独立，一层的变化不会影响到邻层。



## OSI参考模型

![](..\images\1696758054163.png)



| 7. 应用层     | 对应用程序提供接口。                                         |
| ------------- | ------------------------------------------------------------ |
| 6. 表示层     | 进行数据格式的转换，以确保一个系统生成的应用层数据能够被另外一个系统的应用层所识别和理解。 |
| 5. 会话层     | 在通信双方之间建立、管理和终止会话。                         |
| 4. 传输层     | 建立、维护和取消一次端到端的数据传输过程。控制传输节奏的快慢，调整数据的排序等等。 |
| 3. 网络层     | 定义逻辑地址；实现数据从源到目的地的转发。                   |
| 2. 数据链路层 | 将分组数据封装成帧；在数据链路上实现数据的点到点、或点到多点方式的直接通信；差错检测。 |
| 1. 物理层     | 在媒介上传输比特流；提供机械的和电气的规约。                 |



## TCP/IP模型

因为OSI协议栈比较复杂，且TCP和IP两大协议在业界被广泛使用，所以TCP/IP参考模型成为了互联网的主流参考模型。

![](..\images\20240218182149.png)



### TCP/IP常见协议

| 应用层     | Telnet FTP TFTP SNMP  HTTP SMTP DNS DHCP |
| ---------- | ---------------------------------------- |
| 传输层     | TCP UDP                                  |
| 网络层     | ICMP IGMP IP                             |
| 数据链路层 | PPPoE  Ethernet（IEE802.3）  PPP         |
| 物理层     | RS2032                                   |



### 常见协议标准化组织

IETF(Internet Engineering Task Force)负责开发和推广互联网协议（特别是构成TCP/IP协议族的协议）的志愿组织，通过RFC发布新的或者取代老的协议标准。

IEEE(Institute of Electrical and Electronics Engineers)IEEE制定了全世界电子、电气和计算机科学领域30%左右的标准，比较知名的有IEEE802.3(Ethernet)、IEEE802.11(WiFi)等。

ISO(International Organization for Standardization)在制定计算机网络标准方面，ISO是起着重大作用的国际组织，如OSI模型，定义于ISO/IEC 7498-1。



## 应用层

应用层为应用软件提供接口，使应用程序能够使用网络服务。

应用层协议会指定使用相应的传输层协议，以及传输层所使用的端口等。应用层的PDU被称为Data（数据）。

![](..\images\20240218183206.png)



## 传输层

传输层协议接收来自应用层协议的数据，封装上相应的传输层头部，帮助其建立“端到端”（Port to Port）的连接。

传输层的PDU被称为Segment（段）。

![](..\images\20240218183349.png)



### TCP和UDP报文格式

TCP
TCP头部20 Byte

|                       Source Port(16)                        | Destination port (16) |
| :----------------------------------------------------------: | --------------------- |
|                   **Sequence number (32)**                   |                       |
|               **Acknowledgement number (32)**                |                       |
| **Header length (4)  Reserved (6)  Control bits (6)  Window (16)** |                       |
|                      **Checksum (16)**                       | **Urgent (16)**       |
|                         **Options**                          |                       |
|                      **Data (varies)**                       |                       |



UDP

UDP头部8 Byte

| Source port (16) | Destination port (16) |
| ---------------- | --------------------- |
| Length (16)      | Checksum (16)         |
| Data (if any)    |                       |



### TCP和UDP端口号

![](..\images\20240218184232.png)

客户端使用的源端口一般随机分配，目标端口则由服务器的应用指定；

源端口号一般为系统中未使用的，且大于1023；

目的端口号为服务端开启的应用（服务）所侦听的端口，如HTTP缺省使用80。

例：本地访问某个网站，源端口即本地端口(端口号必须大于1023)，网站服务端口号是80。



### TCP建立过程



任何基于TCP的应用，在发送数据之前，都需要由TCP进行“三次握手”建立连接。TCP传输过程中几个比较重要的参数：



1. Source Address 源地址 
2. Source Port 源端口号
3. Destination Address 目的地址
4. Destination Port 目的端口号
5. Sequence Number（Seq） 序列号
6. Acknowledgment Number (Ack)  确认编号
7. Flags  标志位(取值时 SYN  ACK PUSH FIN对应位置设置为1)
8. Window  滑动窗口大小(TCP流控时使用)
9. Payload 数据载荷(实际存放数据)



![](..\images\20240219190524.png)



### 三次握手逻辑示意图

![](..\images\20240219192235.png)



TCP连接的三次握手：
第一次(A--->B)，SYN=1，seq=x
第二次(B--->A)，SYN=1，ACK=1，seq=y，ack=x+1 
第三次(A--->B)，ACK=1，seq=x+1,ack=y+1 

seq是序列号，这是为了连接以后传送数据用的，ack是对收到的数据包的确认，值是等待接收的数据包的序列号。

在第一次消息发送中，A随机选取一个序列号作为自己的初始序号发送给B；

第二次消息B使用ack对A的数据包进行确认，因为已经收到了序列号为x的数据包，准备接收序列号为x+1的包，所以ack=x+1，同时B告诉A自己的初始序列号，就是seq=y；

第三条消息A告诉B收到了B的确认消息并准备建立连接，A自己此条消息的序列号是x+1，所以seq=x+1，而ack=y+1是表示A正准备接收B序列号为y+1的数据包。

seq是数据包本身的序列号；ack是期望对方继续发送的那个数据包的序列号。



### 抓包数据

![](..\images\20240219192445.png)



![](..\images\20240219192628.png)



![](..\images\20240219192747.png)





### TCP传输数据过程

以HTTP请求响应为例。





### 传输数据逻辑示意图

![](..\images\20240219194744.png)

### 抓包数据

![](..\images\20240219194933.png)



![](..\images\20240219195044.png)



![](..\images\20240219195152.png)



### TCP连接断开过程

连接断开四次挥手。



### 逻辑示意图

![](..\images\20240219200421.png)



### 抓包数据

![](..\images\20240219200526.png)



![](..\images\20240219200621.png)



![](..\images\20240219200810.png)







### TCP建立连接、传输数据、断开连接整个流程

![](..\images\20240220092357.png)



Seq=Seq当前值➕本次发送数据的大小  

Ack=Ack当前值➕收到数据大小 

除了数据传输过程外，Seq和ACK都是一次请求和响应后+1



## 数据链路层



数据链路层位于网络层和物理层之间，可以向网络层的IP、IPv6等协议提供服务。数据链路层的PDU被称为**Frame（帧）**。以太网（Ethernet）是最常见的数据链路层协议。

常见的数据链路层协议有：以太网（Ethernet）、PPPoE、PPP等。



以太网是一种广播式数据链路层协议，支持多点接入。

MAC (Media Access Control)地址在网络中唯一标识一个网卡，每个网卡都需要且会有唯一的一个MAC地址。MAC用于在一个IP网段内，寻址找到具体的物理设备。

工作在数据链路层的设备。例如以太网交换机，会维护一张MAC地址表，用于指导数据帧转发。



ARP （Address Resolution Protocol）地址解析协议：根据已知的IP地址解析获得其对应的MAC地址。

![](..\images\20240221164755.png)

### 以太网帧

以太网技术所使用的帧就是以太网帧。以太网帧有2个标准：Ethernet_ll格式和IEEE 802.3格式。



Ethernet_ll：目的MAC地址+源MAC地址+网络层协议类型+用户数据+帧尾

IEEE 802.3：目的MAC地址+源MAC地址+长度+用户数据+帧尾

**Length/Type >= 1536(Ox0600)       Ethernet_ll （绝大部分应用传输数据使用的帧格式）**

**Length/Type <= 1500(Ox05DC)       IEEE802.3   （底层协议使用的帧格式）**



Ethernet_ll比较常用，IEEE 802.3主要用在ISIS（动态路由协议）



### MAC地址

一个MAC地址有48bit，6Byte。MAC地址即网卡地址。

```
十六进制表示法
14-DD-A9-EA-6F-B7
二进制表示法
00010100-11011101-10101001-11101010-01101111-10110111
```



### MAC地址构成

1. OUI： 厂商代码，由IEEE分配，3Byte, 24 bit。
2. 制造商分配：3Byte,  24bit。



单播MAC地址：1对1通信。前三段是OUI地址，第8位取值0

组播MAC地址：1对多通信。前三段非OUI地址，第8位取值1

广播MAC地址：FF-FF-FF-FF-FF-FF



以太网帧结构

|        |             |      |
| ------ | ----------- | ---- |
| Eth_II | ARP Request | FCS  |



![1708505488534](..\images\1708505488534.png)



Step 4：所有的主机接收到该ARP Request报文后，都会检查它的目的端IP地址字段与自身的IP地址是否匹配。

主机2发现IP地址匹配，则会将ARP报文中的发送端MAC地址和发送端IP地址信息记录到自己的ARP缓存表中。



Step 5：主机2通过发送ARP Reply报文来响应主机1的请求。此时主机2已知主机1的MAC地址，因此ARP Reply是**单播数据帧**。



Step 6：交换机收到该单播数据帧后，会对该帧执行转发操作。



Step 7：主机1收到ARP Reply以后，会检查ARP报文中目的端IP地址字段是否与自己的IP地址匹配。如果匹配，会将ARP报文中的发送端MAC地址和发送端IP地址信息记录到自己的ARP缓存表中。



### ARP抓包

网络拓扑

![1708505860489](..\images\1708505860489.png)



抓包

![1708505949069](..\images\1708505949069.png)



![1708506003111](..\images\1708506003111.png)



## 物理层

数据到达物理层之后，物理层会根据物理介质的不同，将数字信号转换成光信号、电信号或者是电磁波信号。物理层的PDU被称为比特流（Bitstream）。

![1708505670048](..\images\1708505670048.png)





## 数据通信过程



### 发送方数据封装

![1708505721420](..\images\1708505721420.png)

### 中间网络数据传输

![1708505760308](..\images\1708505760308.png)



### 接收方数据解封装

![1708505792150](..\images\1708505792150.png)